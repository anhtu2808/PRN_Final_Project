@page "/manage/tickets/chat/{ticketId:int}"
@model LaptopRentalManagement.Pages.Manage.Tickets.ChatModel
@{
    ViewData["Title"] = "Ticket Chat";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="container py-4">
    <h2 class="mb-3">Chat for Ticket #@Model.TicketId</h2>
    <div id="messages" class="border rounded p-3 mb-3" style="height:300px; overflow-y:auto;">
        @foreach (var msg in Model.Messages)
        {
            <div>@msg.SenderName: @msg.Content</div>
        }
    </div>
    <div class="input-group">
        <input id="messageInput" class="form-control" placeholder="Type a message" />
        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    <script>
        const ticketId = @Model.TicketId;
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/ticketChatHub")
            .build();

        connection.on("ReceiveMessage", msg => {
            const div = document.createElement('div');
            div.textContent = `${msg.senderName}: ${msg.content}`;
            document.getElementById('messages').appendChild(div);
        });

        connection.start().then(() => {
            connection.invoke('JoinTicket', ticketId);
        });

        document.getElementById('sendBtn').addEventListener('click', () => {
            const text = document.getElementById('messageInput').value.trim();
            if(text){
                connection.invoke('SendMessage', ticketId, text);
                document.getElementById('messageInput').value = '';
            }
        });
    </script>
}
